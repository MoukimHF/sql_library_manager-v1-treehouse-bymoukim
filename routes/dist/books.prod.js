"use strict";function _defineProperty(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}var express=require("express"),router=express.Router(),Sequelize=require("sequelize"),Book=require("../models").Book;function asyncHandler(o){return function(r,t,n){return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(o(r,t,n));case 3:e.next=8;break;case 5:e.prev=5,e.t0=e.catch(0),t.status(500).send(e.t0);case 8:case"end":return e.stop()}},null,null,[[0,5]])}}router.get("/",asyncHandler(function(r,t){var n,o,a,s,i,u,c,d;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.query.page,o=r.query.limit,a=(n-1)*o,e.next=6,regeneratorRuntime.awrap(Book.findAll());case 6:for(s=e.sent,i=s.length/o,u=[],c=0;c<i;c++)u.push(c);return e.next=12,regeneratorRuntime.awrap(Book.findAll({offset:a||0,limit:o||50,order:[["createdAt","DESC"]]}));case 12:d=e.sent,t.render("books/index",{bookss:d,title:"moukim's library!",page:n,limit:o,arrayCount:u});case 14:case"end":return e.stop()}})})),router.get("/new",function(e,r){r.render("books/new-book",{book:{},title:"New book"})}),router.post("/",asyncHandler(function(r,t){var n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(Book.create(r.body));case 3:n=e.sent,t.redirect("/books/"+n.id),e.next=17;break;case 7:if(e.prev=7,e.t0=e.catch(0),"SequelizeValidationError"===e.t0.name)return e.next=12,regeneratorRuntime.awrap(Book.build(r.body));e.next=16;break;case 12:n=e.sent,t.render("books/new-book",{book:n,errors:e.t0.errors,title:"New book"}),e.next=17;break;case 16:throw e.t0;case 17:case"end":return e.stop()}},null,null,[[0,7]])})),router.get("/:id/edit",asyncHandler(function(r,t){var n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(Book.findByPk(r.params.id));case 2:(n=e.sent)?t.render("books/update-book",{book:n,title:"Edit book"}):t.render("notFoundError");case 4:case"end":return e.stop()}})})),router.get("/:id",asyncHandler(function(r,t){var n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(Book.findByPk(r.params.id));case 2:(n=e.sent)?t.render("books/show",{book:n,title:n.title}):t.render("notFoundError");case 4:case"end":return e.stop()}})})),router.post("/:id/edit",asyncHandler(function(r,t){var n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(Book.findByPk(r.params.id));case 3:if(n=e.sent)return e.next=7,regeneratorRuntime.awrap(n.update(r.body));e.next=10;break;case 7:t.redirect("/books/"+n.id),e.next=11;break;case 10:t.render("notFoundError");case 11:e.next=24;break;case 13:if(e.prev=13,e.t0=e.catch(0),"SequelizeValidationError"===e.t0.name)return e.next=18,regeneratorRuntime.awrap(Book.build(r.body));e.next=23;break;case 18:(n=e.sent).id=r.params.id,t.render("books/update-book",{book:n,errors:e.t0.errors,title:"Edit book"}),e.next=24;break;case 23:throw e.t0;case 24:case"end":return e.stop()}},null,null,[[0,13]])})),router.get("/:id/delete",asyncHandler(function(r,t){var n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(Book.findByPk(r.params.id));case 2:(n=e.sent)?t.render("books/delete",{book:n,title:"Delete book"}):t.render("notFoundError");case 4:case"end":return e.stop()}})})),router.post("/search",asyncHandler(function(r,t){var n,o,a,s,i,u,c,d,l,p,k;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return t.redirect("/books/search/?page=1&limit=5"),n=r.body.query,o=r.path,a=Sequelize.Op,s=r.query.page,i=r.query.limit,u=(s-1)*i,console.log("1 : "+r.body.query),console.log("2 : "+r.query.page),console.log("3 "+r),e.next=13,regeneratorRuntime.awrap(Book.findAll({where:_defineProperty({},a.or,{title:_defineProperty({},a.like,"%"+n+"%"),author:_defineProperty({},a.like,"%"+n+"%"),genre:_defineProperty({},a.like,"%"+n+"%"),year:_defineProperty({},a.like,"%"+n+"%")}),offset:u||0,limit:i||50,order:[["createdAt","DESC"]]}));case 13:if(c=e.sent,d=c.length/i,l=[],!o.includes("search")){e.next=32;break}if(!(0<c.length)){e.next=24;break}for(p=0;p<d;p++)l.push(p);console.log("sayeb zebi ya khra"),console.log(d),t.render("books/index",{bookss:c,title:"moukim's library!",page:s,limit:i,arrayCount:l}),e.next=32;break;case 24:throw k=[],e.prev=25,new Error("no search results");case 29:e.prev=29,e.t0=e.catch(25),t.render("books/index2",{books:c,arrayCount:k,error:e.t0});case 32:case"end":return e.stop()}},null,null,[[25,29]])})),router.post("/:id/delete",asyncHandler(function(r,t){var n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(Book.findByPk(r.params.id));case 2:if(n=e.sent)return e.next=6,regeneratorRuntime.awrap(n.destroy());e.next=9;break;case 6:t.redirect("/books"),e.next=10;break;case 9:t.render("notFoundError");case 10:case"end":return e.stop()}})})),module.exports=router;